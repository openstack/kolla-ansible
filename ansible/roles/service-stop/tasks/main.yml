---
- name: "Stopping containers for {{ service_name }}"
  vars:
    service: "{{ item.value }}"
  become: true
  kolla_container:
    action: "stop_container"
    common_options: "{{ docker_common_options }}"
    name: "{{ service.container_name }}"
    ignore_missing: "{{ kolla_action_stop_ignore_missing | bool }}"
  when:
    - service.container_name not in skip_stop_containers
    - not (service.iterate | default(False)) | bool
  with_dict: "{{ project_services | select_services_enabled_and_mapped_to_host }}"

- name: Include tasks for iterated containers
  vars:
    service: "{{ outer_item.value }}"
  include_tasks: iterated.yml
  loop: "{{ project_services | select_services_enabled_and_mapped_to_host | dict2items }}"
  loop_control:
    loop_var: outer_item
  when:
    - (service.iterate | default(False)) | bool
    - service.iterate_var is defined
