---
- name: Ensuring private libvirt directory exist
  file:
    path: "{{ certificates_libvirt_dir }}"
    mode: "0770"
    state: "directory"

- name: Creating libvirt certificate key
  community.crypto.openssl_privatekey:
    path: "{{ certificates_libvirt_dir }}/libvirt.key"
    mode: "0660"
    size: 2048
    type: RSA

- name: Creating libvirt certificate signing request
  community.crypto.openssl_csr:
    path: "{{ certificates_libvirt_dir }}/libvirt.csr"
    country_name: "US"
    digest: "sha256"
    locality_name: "RTP"
    organizational_unit_name: "kolla"
    privatekey_path: "{{ certificates_libvirt_dir }}/libvirt.key"
    state_or_province_name: "NC"
    subject_alt_name: >-
      {%- set _san = [] -%}
      {%- for host in groups['compute'] -%}
      {{ _san.append('DNS:' ~ (hostvars[host].migration_hostname | default(hostvars[host].ansible_facts.nodename))) }}
      {%- endfor -%}
      {{ _san }}

- name: Creating libvirt certificate from CSR
  community.crypto.x509_certificate:
    path: "{{ certificates_libvirt_dir }}/libvirt.crt"
    csr_path: "{{ certificates_libvirt_dir }}/libvirt.csr"
    ownca_digest: "sha256"
    ownca_not_after: "+500d"
    ownca_path: "{{ certificates_root_dir }}/root.crt"
    ownca_privatekey_path: "{{ certificates_root_dir }}/root.key"
    privatekey_path: "{{ certificates_libvirt_dir }}/libvirt.key"
    provider: ownca

- name: Setting permissions on libvirt key
  file:
    path: "{{ certificates_libvirt_dir }}/libvirt.key"
    mode: "0660"
    state: file

- name: Ensure libvirt output directory exists
  file:
    path: "{{ certificates_libvirt_output_dir }}"
    state: directory
    mode: "0770"

- name: Copy libvirt root CA to default configuration location
  copy:
    src: "{{ certificates_root_dir }}/root.crt"
    dest: "{{ certificates_libvirt_output_dir }}/cacert.pem"
    mode: "0660"

- name: Copy libvirt cert to default configuration locations
  copy:
    src: "{{ certificates_libvirt_dir }}/libvirt.crt"
    dest: "{{ certificates_libvirt_output_dir }}/{{ item }}cert.pem"
    mode: "0660"
  loop:
    - server
    - client

- name: Copy libvirt key to default configuration locations
  copy:
    src: "{{ certificates_libvirt_dir }}/libvirt.key"
    dest: "{{ certificates_libvirt_output_dir }}/{{ item }}key.pem"
    mode: "0660"
  loop:
    - server
    - client
